calculateBtn.addEventListener('click', () => {
  clearInterval(countdownInterval);
  clearInterval(xpInterval);
  warning.textContent = '';
  output.classList.remove('visible');
  xpBar.style.width = '0%';
  xpLabel.textContent = '‚Äî';

  // Internally subtract 1 from ages for calculation
  const inputStartAge = +document.getElementById('currentAge').value;
  const inputTargetAge = +document.getElementById('targetAge').value;
  const startAge = inputStartAge - 1;
  const targetAge = inputTargetAge - 1;

  const rate = +document.getElementById('xps').value;
  let currXP = +document.getElementById('currentXP').value || 0;

  if (
    !Number.isFinite(inputStartAge) ||
    !Number.isFinite(inputTargetAge) ||
    !Number.isFinite(rate) ||
    targetAge <= startAge ||
    rate <= 0
  ) {
    warning.textContent = '‚ö†Ô∏è Please check your inputs.';
    return;
  }

  let age = startAge;
  const totalXPtoTarget = [...Array(targetAge - startAge)]
    .map((_, i) => xpForAge(startAge + i + 1))
    .reduce((a, b) => a + b, 0);
  const remainingXP = totalXPtoTarget - currXP;
  let remainingSec = Math.floor(remainingXP / rate);

  output.innerHTML = `
    üß™ <strong>Total XP Remaining</strong>: ${remainingXP.toLocaleString()} XP<br>
    ‚è≥ <strong>Estimated Time</strong>: ${formatTime(remainingSec)}
  `;
  output.classList.add('visible');

  countdown.textContent = `‚è≥ Time left: ${formatTime(remainingSec)}`;
  countdownInterval = setInterval(() => {
    remainingSec--;
    countdown.textContent = remainingSec > 0
      ? `‚è≥ Time left: ${formatTime(remainingSec)}`
      : 'üéâ Done!';
    if (remainingSec <= 0) clearInterval(countdownInterval);
  }, 1000);

  let xpNeeded = xpForAge(age + 1);
  xpLabel.textContent = `Level ${age + 1} ‚Üí ${age + 2}: ${Math.floor(currXP)}/${xpNeeded} XP`;
  xpBar.style.width = `${(currXP / xpNeeded) * 100}%`;

  xpInterval = setInterval(() => {
    currXP += rate;
    if (currXP >= xpNeeded) {
      currXP -= xpNeeded;
      age++;
      xpBar.classList.add('level-up');
      xpLabel.classList.add('level-up');
      setTimeout(() => {
        xpBar.classList.remove('level-up');
        xpLabel.classList.remove('level-up');
      }, 500);
      if (age >= targetAge) {
        xpBar.style.width = '100%';
        xpLabel.textContent = `Level ${age + 1} reached!`;
        clearInterval(xpInterval);
        createConfetti();
        return;
      }
      xpNeeded = xpForAge(age + 1);
    }
    xpBar.style.width = `${(currXP / xpNeeded) * 100}%`;
    xpLabel.textContent = `Level ${age + 1} ‚Üí ${age + 2}: ${Math.floor(currXP)}/${xpNeeded} XP`;
  }, 1000);
});
